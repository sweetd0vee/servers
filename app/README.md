# –ü–∞–∫–µ—Ç `app/` - AIOps Dashboard Application

## üìã –û–±–∑–æ—Ä

–ü–∞–∫–µ—Ç `app/` —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–Ω–æ–≤–Ω–æ–µ Streamlit –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –º–µ—Ç—Ä–∏–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å AI-powered –∞–Ω–∞–ª–∏–∑–æ–º.
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫ CPU, Memory, Disk –∏ Network, –∞ —Ç–∞–∫–∂–µ —Ñ—É–Ω–∫—Ü–∏–∏
–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π –∏ AI-–∞–Ω–∞–ª–∏–∑–∞.

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–∫–µ—Ç–∞

```
app/
‚îú‚îÄ‚îÄ __init__.py              # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–∫–µ—Ç–∞, —ç–∫—Å–ø–æ—Ä—Ç logger
‚îú‚îÄ‚îÄ app_new.py              # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (production)
‚îú‚îÄ‚îÄ app.py                  # Legacy –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ auth.py                 # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Keycloak
‚îú‚îÄ‚îÄ config.py               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ø–æ—Ä–æ–≥–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ LLM)
‚îú‚îÄ‚îÄ cpu.py                  # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è CPU –º–µ—Ç—Ä–∏–∫
‚îú‚îÄ‚îÄ mem.py                  # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è Memory –º–µ—Ç—Ä–∏–∫
‚îú‚îÄ‚îÄ table.py                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü –∏ —Ç–∞–π–º–ª–∞–π–Ω–æ–≤
‚îú‚îÄ‚îÄ anomalies.py             # –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π
‚îú‚îÄ‚îÄ llm.py                  # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LLM (HuggingFace API)
‚îú‚îÄ‚îÄ llm_api.py             # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ LLM
‚îî‚îÄ‚îÄ llm_api_upgrade.py     # –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
```

## üì¶ –ú–æ–¥—É–ª–∏

### 1. `app_new.py` - –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ì–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å Streamlit –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –°–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É –¥–∞—à–±–æ—Ä–¥–∞, –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö, –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- `load_and_prepare_data(data_source='db', vm=None, start_date=None, end_date=None)` - –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î –∏–ª–∏ Excel
- `create_summary_metrics(df)` - –°–æ–∑–¥–∞–Ω–∏–µ —Å–≤–æ–¥–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
- `main()` - –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
- `run_app()` - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
streamlit run app/app_new.py
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö: PostgreSQL –∏ Excel
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Keycloak –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –†–æ–ª–µ–≤–æ–π –¥–æ—Å—Ç—É–ø (Admin, User, Viewer)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `@st.cache_data`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ Excel –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î

---

### 2. `auth.py` - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–æ–¥—É–ª—å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Keycloak OAuth2. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- `login_page()` - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞
- `check_auth()` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `verify_token(token)` - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞
- `get_current_user()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- `has_role(required_roles)` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `require_auth(func)` - –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∑–∞—â–∏—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π
- `require_role(required_roles)` - –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏
- `logout_user()` - –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from app.auth import require_auth, get_current_user, has_role

@require_auth
def protected_function():
    user = get_current_user()
    if has_role(["admin"]):
        # –ê–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
        pass
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è):**

```env
KEYCLOAK_URL=http://localhost:8080
KEYCLOAK_REALM=myrealm
KEYCLOAK_CLIENT_ID=streamlit-app
KEYCLOAK_CLIENT_SECRET=your-secret
KEYCLOAK_REDIRECT_URI=http://localhost:8501
```

**–†–æ–ª–∏:**

- `admin` - –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏
- `user` - –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –∞–Ω–∞–ª–∏–∑ –∞–Ω–æ–º–∞–ª–∏–π
- `viewer` - –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞—à–±–æ—Ä–¥–∞

---

### 3. `config.py` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–û–ø–∏—Å–∞–Ω–∏–µ:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

```python
# –ü–æ—Ä–æ–≥–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
CPU_THRESHOLDS = {
    'low': 20,    # < 20% - –Ω–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
    'high': 70    # > 70% - –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
}

MEMORY_THRESHOLDS = {
    'low': 30,    # < 30% - –Ω–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
    'high': 80    # > 80% - –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ LLM
LLM_URL = "http://llama-server:8080/completion"
LLM_TIMEOUT = 90
LLM_MAX_TOKENS = 500
```

---

### 4. `cpu.py` - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è CPU

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–æ–¥—É–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π –º–µ—Ç—Ä–∏–∫ CPU —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Plotly.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- `create_cpu_heatmap(df)` - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CPU
- `create_cpu_load_chart(df)` - –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CPU
- `create_empty_plot(message)` - –°–æ–∑–¥–∞–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- `create_error_plot(error_message)` - –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å –æ—à–∏–±–∫–æ–π
- `log_cpu_statistics(df)` - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ CPU

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from app.cpu import create_cpu_heatmap, create_cpu_load_chart
import pandas as pd

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
df = pd.DataFrame(...)  # –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å: vm, date, metric, avg_value

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π
heatmap = create_cpu_heatmap(df)
chart = create_cpu_load_chart(df)

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ Streamlit
st.plotly_chart(heatmap, use_container_width=True)
st.plotly_chart(chart, use_container_width=True)
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–∞–Ω–Ω—ã–º:**

DataFrame –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–ª–æ–Ω–∫–∏:
- `vm` - –∏–º—è —Å–µ—Ä–≤–µ—Ä–∞
- `date` - –¥–∞—Ç–∞ –º–µ—Ç—Ä–∏–∫–∏
- `metric` - –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'cpu.usage.average')
- `avg_value` - —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

---

### 5. `mem.py` - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è Memory

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–æ–¥—É–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π –º–µ—Ç—Ä–∏–∫ –ø–∞–º—è—Ç–∏.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- `create_memory_heatmap(df)` - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
- `create_memory_load_chart(df)` - –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–º—è—Ç–∏
- `create_empty_plot(message)` - –°–æ–∑–¥–∞–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
- `create_error_plot(error_message)` - –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å –æ—à–∏–±–∫–æ–π
- `log_memory_statistics(df)` - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–∞–º—è—Ç–∏

### 6. `table.py` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–æ–¥—É–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ —Ç–∞–π–º–ª–∞–π–Ω–æ–≤ –Ω–∞–≥—Ä—É–∑–∫–∏.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- `create_server_classification_table(df)` - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤
- `create_load_timeline(df, selected_server)` - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–π–º–ª–∞–π–Ω–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from app.table import create_server_classification_table, create_load_timeline

# –¢–∞–±–ª–∏—Ü–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
classification_df = create_server_classification_table(df)
st.dataframe(classification_df, use_container_width=True)

# –¢–∞–π–º–ª–∞–π–Ω –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
timeline = create_load_timeline(df, 'server-01')
st.plotly_chart(timeline, use_container_width=True)
```

**–§–æ—Ä–º–∞—Ç —Ç–∞–±–ª–∏—Ü—ã –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:**

| –°–µ—Ä–≤–µ—Ä | –°—Ä–µ–¥–Ω–∏–π CPU % | CPU –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –°—Ä–µ–¥–Ω—è—è Memory % | Memory –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|--------|---------------|---------------|------------------|------------------|--------------|
| server-01 | 45.2 | üü° –ù–æ—Ä–º–∞–ª—å–Ω–∞—è | 60.5 | üü° –ù–æ—Ä–º–∞–ª—å–Ω–∞—è | –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ |

---

### 7. `anomalies.py` - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–æ–¥—É–ª—å –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∞–Ω–æ–º–∞–ª–∏–π –∏ AI-–∞–Ω–∞–ª–∏–∑–∞ –º–µ—Ç—Ä–∏–∫.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- `detect_statistical_anomalies(df, server_name=None)` - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∞–Ω–æ–º–∞–ª–∏–π (–º–µ—Ç–æ–¥ 3 —Å–∏–≥–º)
- `get_server_context(df, server_name=None)` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞
- `create_anomaly_detection_section(df)` - –°–æ–∑–¥–∞–Ω–∏–µ UI —Å–µ–∫—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞–Ω–æ–º–∞–ª–∏–π

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from app.anomalies import detect_statistical_anomalies, create_anomaly_detection_section

# –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π
anomalies = detect_statistical_anomalies(df, server_name='server-01')

for anomaly in anomalies:
    print(f"–ê–Ω–æ–º–∞–ª–∏—è: {anomaly['metric']} = {anomaly['value']} "
          f"(Z-score: {anomaly['z_score']:.2f})")

# –í Streamlit
create_anomaly_detection_section(df)
```

**–§–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–æ–º–∞–ª–∏–π:**

```python
{
    'server': 'server-01',
    'date': '2025-01-15',
    'metric': 'cpu.usage.average',
    'value': 95.5,
    'mean': 45.2,
    'std': 12.3,
    'z_score': 4.09,
    'type': 'statistical_outlier'
}
```

---

### 8. `llm.py` - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LLM

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–æ–¥—É–ª—å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å LLM —á–µ—Ä–µ–∑ HuggingFace API –∏ –ª–æ–∫–∞–ª—å–Ω—ã–π llama-server.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- `call_ai_analysis(context)` - –í—ã–∑–æ–≤ AI-–∞–Ω–∞–ª–∏–∑–∞ —Å fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π
- `local_ai_analysis(context)` - –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from app.llm import call_ai_analysis

context = {
    'servers': {
        'server-01': {
            'cpu_avg': 85.5,
            'mem_avg': 70.2
        }
    },
    'statistical_anomalies': [...]
}

analysis = call_ai_analysis(context)
print(analysis)
```

**Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:**

1. –ü–æ–ø—ã—Ç–∫–∞ 1: –õ–æ–∫–∞–ª—å–Ω—ã–π llama-server (http://llama-server:8080)
2. –ü–æ–ø—ã—Ç–∫–∞ 2: HuggingFace API (–º–æ–¥–µ–ª—å 1)
3. –ü–æ–ø—ã—Ç–∫–∞ 3: HuggingFace API (–º–æ–¥–µ–ª—å 2)
4. Fallback: Rule-based –∞–Ω–∞–ª–∏–∑

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**

```env
HUGGINGFACE_API_KEY=your-api-key
LLM_URL=http://llama-server:8080/completion
LLM_TIMEOUT=90
LLM_MAX_TOKENS=500
```

---

### 9. `llm_api.py` –∏ `llm_api_upgrade.py` - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ LLM —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å LLM, –≤–∫–ª—é—á–∞—è –ø—Ä—è–º—É—é —Ä–∞–±–æ—Ç—É —Å Transformers.

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–∏ –º–æ–¥—É–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –î–ª—è production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `llm.py`.

---

## üîß –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```python
streamlit>=1.50.0          # Web framework
pandas>=2.3.3              # Data processing
plotly>=6.5.0              # Visualization
sqlalchemy>=1.4.41          # Database ORM
psycopg2-binary>=2.9.11    # PostgreSQL driver
PyJWT>=2.10.1              # JWT token handling
requests>=2.32.5            # HTTP requests
python-dotenv>=1.2.1       # Environment variables
```

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```python
transformers>=4.57.3       # –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ LLM
torch>=2.2.2               # –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ LLM
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
# Database
DB_HOST=postgres
DB_PORT=5432
DB_NAME=server_metrics
DB_USER=postgres
DB_PASSWORD=your_password

# Keycloak
KEYCLOAK_URL=http://localhost:8080
KEYCLOAK_REALM=myrealm
KEYCLOAK_CLIENT_ID=streamlit-app
KEYCLOAK_CLIENT_SECRET=your-secret
KEYCLOAK_REDIRECT_URI=http://localhost:8501

# LLM
HUGGINGFACE_API_KEY=your-api-key
LLM_URL=http://llama-server:8080/completion
LLM_TIMEOUT=90
LLM_MAX_TOKENS=500
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` –≤ `.env` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è.

### 3. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
# Development
streamlit run app/app.py

# Production (—á–µ—Ä–µ–∑ Docker)
docker-compose up
```

### 4. –î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é

–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä: `http://localhost:8501`

---

## üìä –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 2: –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π

```python
import streamlit as st
from app.cpu import create_cpu_heatmap, create_cpu_load_chart
from app.mem import create_memory_heatmap
from app.table import create_server_classification_table

df = load_and_prepare_data()

# CPU –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
st.subheader("CPU Heatmap")
st.plotly_chart(create_cpu_heatmap(df), use_container_width=True)

st.subheader("CPU Load Chart")
st.plotly_chart(create_cpu_load_chart(df), use_container_width=True)

# Memory –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
st.subheader("Memory Heatmap")
st.plotly_chart(create_memory_heatmap(df), use_container_width=True)

# –¢–∞–±–ª–∏—Ü–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
st.subheader("Server Classification")
classification = create_server_classification_table(df)
st.dataframe(classification, use_container_width=True)
```

### –ü—Ä–∏–º–µ—Ä 3: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π

```python
from app.anomalies import detect_statistical_anomalies, get_server_context
from app.llm import call_ai_analysis

df = load_and_prepare_data()

# –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏
anomalies = detect_statistical_anomalies(df, server_name='server-01')

# AI –∞–Ω–∞–ª–∏–∑
context = get_server_context(df, server_name='server-01')
ai_analysis = call_ai_analysis(context)

print(f"–ù–∞–π–¥–µ–Ω–æ –∞–Ω–æ–º–∞–ª–∏–π: {len(anomalies)}")
print(f"AI –∞–Ω–∞–ª–∏–∑: {ai_analysis}")
```

### –ü—Ä–∏–º–µ—Ä 4: –ó–∞—â–∏—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

```python
from app.auth import require_auth, has_role, get_current_user

@require_auth
def admin_dashboard():
    user = get_current_user()
    st.write(f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.get('name')}!")
    
    if has_role(["admin"]):
        st.button("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏")
        st.button("–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö")
    else:
        st.info("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
Data Source (DB/Excel)
    ‚Üì
load_and_prepare_data()
    ‚Üì
DataFrame
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Visualization  ‚îÇ  Classification ‚îÇ  Anomaly Detect  ‚îÇ
‚îÇ  (cpu, mem)     ‚îÇ  (table)        ‚îÇ  (anomalies)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
Streamlit UI
```

### –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
app_new.py (Main)
    ‚îú‚îÄ‚îÄ auth.py (Authentication)
    ‚îú‚îÄ‚îÄ config.py (Configuration)
    ‚îú‚îÄ‚îÄ cpu.py (CPU Visualization)
    ‚îú‚îÄ‚îÄ mem.py (Memory Visualization)
    ‚îú‚îÄ‚îÄ table.py (Tables & Timelines)
    ‚îú‚îÄ‚îÄ anomalies.py (Anomaly Detection)
    ‚îî‚îÄ‚îÄ llm.py (AI Analysis)
```

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

**–°–∏–º–ø—Ç–æ–º—ã:**
```
‚ö†Ô∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD)
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ fallback –Ω–∞ Excel: `load_and_prepare_data(data_source='xlsx')`

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
```
–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Keycloak
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ KEYCLOAK_URL –¥–æ—Å—Ç—É–ø–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ KEYCLOAK_CLIENT_SECRET

### –ü—Ä–æ–±–ª–µ–º–∞: LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–°–∏–º–ø—Ç–æ–º—ã:**
```
–í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑.
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å llama-server: `http://llama-server:8080`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ HUGGINGFACE_API_KEY
3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è rule-based fallback

---

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –º–æ–¥—É–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ª–æ–≥–≥–µ—Ä –∏–∑ `base_logger.py`:

```python
from base_logger import logger

logger.info("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
logger.warning("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ")
logger.error("–û—à–∏–±–∫–∞", exc_info=True)
logger.debug("–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è")
```

–õ–æ–≥–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤:
- –§–∞–π–ª: `logs/server_analysis_YYYY-MM-DD.log`
- –ö–æ–Ω—Å–æ–ª—å: stdout

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.env` —Ñ–∞–π–ª
2. **–û—Ç–∫–ª—é—á–∏—Ç–µ dev mode –≤ production** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `auth.py`
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS** - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ reverse proxy (Apache HTTPD)
4. **–í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
5. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–æ–ª–µ–≤—É—é –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–∞

---

## ü§ù –í–∫–ª–∞–¥ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π:

1. –°–ª–µ–¥—É–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–æ–¥—É–ª–µ–π
2. –î–æ–±–∞–≤–ª—è–π—Ç–µ docstrings –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ª–æ–≥–≥–µ—Ä
4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ gracefully
5. –î–æ–±–∞–≤–ª—è–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

–°–º. –æ—Å–Ω–æ–≤–Ω–æ–π README –ø—Ä–æ–µ–∫—Ç–∞.

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –Ø–Ω–≤–∞—Ä—å 2025

